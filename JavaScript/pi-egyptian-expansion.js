#!/usr/bin/env js
// requires lib.js


// greedy egyptian fraction expansion of pi
function piEgyptianFractionExpansion(
	useStep1 = true,
	{
		nOverride,
		pOverride,
		baseValueOverride
	} = {}
) {
	// you will probably need to manually make sure the last digit is correct...
	// there is a bug for if it is on the last digit.

	// the precision should be a little more than double the previous
	sMath.precision = 4500; // this is a manual value

	var
		n = nOverride ?? 9n, // natural number.
		p = pOverride ?? 0n, // power
		pi = sMath.piApprox.digits.max,
		approx,
		timeStart,
		timeEnd;

	console.group("computing known terms");
		var BASE_VALUE = baseValueOverride ?? [
			/* these terms need to be put in manually */
			/* d-prec == decimal precision */
			/* ┌────┬──────┬──────┐ */
			/* │indx│d-prec│length│ */
			/* ├────┼──────┼──────┤ */
			/* │ 0  │    0 │      │ */  () => 3n, // represents 1/1 + 1/1 + 1/1
			/* │ 1  │    1 │    1 │ */  () => sMath.inv(8n),
			/* │ 2  │    3 │    2 │ */  () => sMath.inv(61n),
			/* │ 3  │    7 │    4 │ */  () => sMath.inv(5020n),
			/* │ 4  │   17 │    9 │ */  () => sMath.inv(128541455n),
			/* │ 5  │   34 │   18 │ */  () => sMath.inv(162924332716605980n),
			/* │ 6  │   68 │   35 │ */  () => sMath.inv(28783052231699298507846309644849796n),
			/* │ 7  │  137 │   69 │ */  () => sMath.inv(871295615653899563300996782209332544845605756266650946342214549769447n),
			/* │ 8  │  275 │  138 │ */  () => sMath.inv(910061501066771569929177518283776533536956708990096834567481804094469953756509557953741463718463021812584586928871816513428410989679108567n),
			/* │ 9  │  552 │  277 │ */  () => sMath.inv(1519975995495123548864232057230913989322800465552709630913779900493650670821767027219702518074382949141691252249407810669110196772510918483421661269623000241540612237295778589839203838068946388167303612692018867252097220910799910121318313730089594877104929553610347363788990198n),
			/* │ 10 │ 1108 │  553 │ */  () => sMath.inv(3615455471582486000145649018223397099166826163683301789062540270509414959783556780836761642204519869354884239583194801387002048797969779091794868463185702594818005541857630128575946136035053165329955953027655941749295936491729557558509795623239994105636752198836270784061141719941852449881772325462303572255174255057672638567474967542491354471381176431978776054756233942285930200578166190648569473860832228026892389517758910739072052112180302512759973884762505528749693481612414819148862238401215750025609802645249507759302626955226055882048423169423343n),
			/* │ 11 │ 2217 │ 1109 │ */  () => sMath.inv(44307489566534943680673245462504159770281187977643191015419371812634393000467171774383804593891321909064706907093777137161291151633698755098127790260131130447691904647429154709335414247960087137917104875600833337266623752183654599354324990490308332562223348390184611948219514918579489845234698365013397796478714854840642562972820230436312709375435435083574445573053724718588356666401116940513751151217306043649172632623786705270622659362235034562392258756013762402728647299194328632265606494795066906374034167576732264734123090031919070861358419549096834837454639370074304352060364101073076810631784982842723519925131360164706882689225079787446349554004080546731917789072805592046813543159135378307431306080876183415707726907097068958880259114829000271986605457522146630666278182645118473157779897822499164640972052019121154750598694064423247029865182042839418188632791961668626330412746830682144727497777944644616148776909032232648850690189590719183725223256749757437828732837682409265622910158923833325966358322458568736250159945534072134155301696017487287118261706993556548894936260406435592564464187488350n),
			/* │ 12 │>=3669│ 2218 │ */  () => sMath.inv(4367953236304177614190587090632605810582145948988604283642679589949526430347920830575085735420499485563741172858787864117559257618398463948391852107638413257285314116802502271585687535167978582358094765491727244580073091118890550484579423105860537546037483061718236660747620025755811157455826705006738833089488012273502342396962742192972059054147688390000792466147727784807844249515079730071805278405940726682359965642463776501681586703849377021345184716825458957841226986324309445986797677067408879247283235185541107949200602646956907493700108243425184370619508526202183710600603437919004396432139111987130829970865538316640465538995113439674256563705319807216408768264984805289585476782328644447993481091679251838344089515093466887137974811654387885784031612136704680376307813851749440433461169608360908522148256805912161126193099365067180196568125073354240205191839048078885148252326182079162697697796803574838898288453500424001661081391315124673184888792441059103474126250173801944166215016024937759021726502611627955005753827281954663481889983262632177271763972615514851131258404241451394881500490028038381163955241365577765817528192590728325200289650450277079342173239285129271778181331063430790363530755579541899027043256146353345841987111726152699431987243864037145485842076984277841641415664013221673720868708125520954667202380945617338767017236132892903202401012054226057501173915809587767496429354856736622051638588369969315189093811903189050278635491765321994732977139736331410121674927835574501516440335402475082161040440524648319495060259942319472676005796203252771637981834695514422047618968690686219727381163156954314555864628367953271500859086690430743194667122221813925017676648116160463263983032494237074607035328905903920114035490272584294775772153717780738706334441018068117396823791255276386410633471277541764575186785182639503782938134841503617220222442123063195981779012224255102596735458899499729505981225414304127116477971768309516772534671165404656900324587898911705631126217530260571047205168980244724741159587723924353157779229895236378288859046711737047998541778525619234824528543032208666398750292124781847458537653610881440242387138133944144917779365871276292867235683860840947998282964n),
			/* └────┴──────┴──────┘ */
		].reduce((total, fn, i) => {
			console.group(`computing inverse at index ${i}`);
				const value = fn();
				console.log("done");
			console.groupEnd(`computing inverse at index ${i}`);

			return sMath.add(total, value);
		}, sMath.zero);

		localStorage.__BASE_VALUE__ = BASE_VALUE;
		globalThis.__BASE_VALUE__ = BASE_VALUE;

		console.log("done");
	console.groupEnd("computing known terms");


	if (pi.length < sMath.precision + 2)
		throw Error`sMath.piApprox.digits can't match the precision of sMath.precision.\nadd more precision to sMath.piApprox.digits`;

	if (pi.length > sMath.precision + 2)
		pi = pi.slice(0, sMath.precision + 2);

	function getApprox () {
		return sMath.add(
			BASE_VALUE,
			// MUCH faster than sMath.inv(n * 10n**p)
			// sMath.iinv(n) is faster for small n (<~ 5020) and can give wrong answers
			sMath.div10(sMath.inv(n), p)
		);
	}


	if (useStep1) {
		console.group("Stage 1: Find Correct Power of 10");
			console.log("starting power: %cp == %o", "color: darkgray", p);

			while (true) {
				timeStart = performance.now();
					approx = getApprox();
				timeEnd = performance.now();

				if (sMath.eq.le(approx, pi))
					break;

				console.log("%c++p == %o", "color: lightgray", ++p);
			}

			console.log("ending power: %cp == %o", "color: darkgray", p);
			console.log("done");
		console.groupEnd("Stage 1: Find Correct Power of 10");
	}
	else {
		console.group("Stage 1: Find Correct Power of 10");
			console.log("Skipping Stage 1");
			console.log("%cp == %o", "color: darkgray", p);
		console.groupEnd("Stage 1: Find Correct Power of 10");

		console.group("Getting First Approximation");
			timeStart = performance.now();
				approx = getApprox();
			timeEnd = performance.now();

			console.log("done");
		console.groupEnd("Getting First Approximation");
	}

	console.log("Stage 2: Find Correct Digits");

	while (p >= 0n) {
		console.log(
			"%c%sn%cE%c%sn%c : >= %c%sd%c : %o seconds"
			, "color: darkgray"
			, n
			, "color: white"
			, "color: darkgray"
			, p
			, "color: white"
			, "color: #9980FF"
			, fstrdiff(approx, pi) - 1
			, "color: white"
			, timeEnd - timeStart
			,
		);

		if (n % 10n === 0n) {
			p-- !== 0n && (n = 10n*n + 9n);
			continue;
		}

		timeStart = performance.now();
			approx = getApprox();
		timeEnd = performance.now();

		if ( sMath.eq.eq( approx.slice(0, pi.length), pi) )
			throw Error(`approx has more precision than pi. Add more precision.\nCurrent precision: ${sMath.precision}`);

		sMath.eq.gt(approx, pi) ? // approx > pi
			p-- !== 0n ?
				n = 10n*n + 9n :
				--n :
			--n;
	}

	console.log("done");

	console.log(
		"n = %c%sn%c; %c%s digits",
		"color: darkgray;",
		n,
		"color: white;",
		"color: #9980FF;",
		fstrdiff(approx, pi) - 1
	);

	return n + 1n;
}

// piEgyptianFractionExpansion(false, {nOverride: 9n, pOverride: 0n});

var averageDigit = (function averageDigit_closure() {
	function Fraction(a, b) { return [a, b]; }

	return function averageDigit(n) {
		if (typeof n !== "bigint")
			throw TypeError`n must be of type BigInt`;

		const
			s = n.toString(),
			a = s.split("").reduce((t, e) => t + BigInt(e), 0n),
			b = BigInt(s.length);

		return Fraction(a, b);
	}
})();
